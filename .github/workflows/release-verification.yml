# Release Verification Workflow
# Runs smoke checks and monitoring snapshot after promotion
# Validates evidence pack has no SIMULATED content

name: Release Verification

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target environment URL (e.g., https://staging.example.com)'
        required: true
        type: string
      evidence_pack_path:
        description: 'Path to evidence pack file to validate (optional)'
        required: false
        default: ''
        type: string
  workflow_call:
    inputs:
      target_url:
        description: 'Target environment URL'
        required: true
        type: string
      evidence_pack_path:
        description: 'Path to evidence pack file to validate'
        required: false
        default: ''
        type: string

env:
  NODE_VERSION: '22'

jobs:
  smoke-checks:
    name: Smoke Checks
    runs-on: ubuntu-latest
    outputs:
      smoke_status: ${{ steps.smoke.outputs.status }}
    
    steps:
      - name: Log CI context
        env:
          REPO_CONTEXT: "job-sheet-qa-auditor (TypeScript/Node)"
        run: |
          echo "=================================================="
          echo "  REPO:       ${REPO_CONTEXT}"
          echo "  WORKFLOW:   ${{ github.workflow }}"
          echo "  JOB:        ${{ github.job }}"
          echo "  SHA:        ${{ github.sha }}"
          echo "  REF:        ${{ github.ref }}"
          echo "  EVENT:      ${{ github.event_name }}"
          echo "  TARGET:     ${{ inputs.target_url }}"
          echo "=================================================="

      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Smoke Checks
        id: smoke
        run: |
          chmod +x scripts/release/smoke-check.sh
          if ./scripts/release/smoke-check.sh "${{ inputs.target_url }}"; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload Smoke Check Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-check-logs-${{ github.run_number }}
          path: logs/release/smoke/
          retention-days: 30
          if-no-files-found: ignore

  monitoring-snapshot:
    name: Monitoring Snapshot
    runs-on: ubuntu-latest
    needs: smoke-checks
    
    steps:
      - name: Log CI context
        env:
          REPO_CONTEXT: "job-sheet-qa-auditor (TypeScript/Node)"
        run: |
          echo "=================================================="
          echo "  REPO:       ${REPO_CONTEXT}"
          echo "  WORKFLOW:   ${{ github.workflow }}"
          echo "  JOB:        ${{ github.job }}"
          echo "  SHA:        ${{ github.sha }}"
          echo "  REF:        ${{ github.ref }}"
          echo "  EVENT:      ${{ github.event_name }}"
          echo "  TARGET:     ${{ inputs.target_url }}"
          echo "=================================================="

      - name: Checkout
        uses: actions/checkout@v4

      - name: Capture Monitoring Snapshot
        run: |
          chmod +x scripts/release/monitor-snapshot.sh
          ./scripts/release/monitor-snapshot.sh "${{ inputs.target_url }}"

      - name: Upload Monitoring Snapshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: monitoring-snapshot-${{ github.run_number }}
          path: logs/release/monitoring/
          retention-days: 30
          if-no-files-found: ignore

  validate-evidence-pack:
    name: Validate Evidence Pack
    runs-on: ubuntu-latest
    if: inputs.evidence_pack_path != ''
    
    steps:
      - name: Log CI context
        env:
          REPO_CONTEXT: "job-sheet-qa-auditor (TypeScript/Node)"
        run: |
          echo "=================================================="
          echo "  REPO:       ${REPO_CONTEXT}"
          echo "  WORKFLOW:   ${{ github.workflow }}"
          echo "  JOB:        ${{ github.job }}"
          echo "  SHA:        ${{ github.sha }}"
          echo "  REF:        ${{ github.ref }}"
          echo "  EVENT:      ${{ github.event_name }}"
          echo "  EVIDENCE:   ${{ inputs.evidence_pack_path }}"
          echo "=================================================="

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate Evidence Pack
        run: |
          npx tsx scripts/release/validate-evidence-pack.ts --input "${{ inputs.evidence_pack_path }}"

  generate-summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [smoke-checks, monitoring-snapshot]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ” Release Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Target URL | \`${{ inputs.target_url }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.smoke-checks.outputs.smoke_status }}" = "passed" ]; then
            echo "| Smoke Checks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Smoke Checks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| Monitoring Snapshot | âœ… Captured |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- smoke-check-logs-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- monitoring-snapshot-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
