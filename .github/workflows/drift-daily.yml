# DAILY DRIFT DETECTION WORKFLOW
# Runs drift detection daily to identify accuracy degradation.
#
# Schedule: Daily at 6:00 AM UTC
# Manual trigger: workflow_dispatch with optional baseline creation
#
# Does NOT require secrets for PR CI (runs in local mode).

name: Drift Detection (Daily)

on:
  # Daily schedule
  schedule:
    - cron: '0 6 * * *'  # 6:00 AM UTC daily
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      create_baseline:
        description: 'Create new baseline from current metrics'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target environment'
        required: false
        type: choice
        options:
          - local
          - staging
          - production
        default: local

env:
  NODE_VERSION: "22"

jobs:
  drift-check:
    name: Run Drift Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run drift detection
        id: drift
        run: |
          if [ "${{ github.event.inputs.create_baseline }}" = "true" ]; then
            pnpm drift:baseline
          else
            pnpm drift:check || true
          fi
        env:
          DRIFT_ENVIRONMENT: ${{ github.event.inputs.environment || 'local' }}
      
      - name: Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ github.run_id }}
          path: scripts/drift/reports/latest.json
          retention-days: 30
      
      - name: Check for critical alerts
        run: |
          if [ -f scripts/drift/reports/latest.json ]; then
            CRITICAL=$(cat scripts/drift/reports/latest.json | jq '.summary.criticalAlerts // 0')
            echo "Critical alerts: $CRITICAL"
            if [ "$CRITICAL" -gt 0 ]; then
              echo "::warning::$CRITICAL critical drift alert(s) detected!"
            fi
          fi
      
      - name: Summary
        run: |
          echo "## Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f scripts/drift/reports/latest.json ]; then
            echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
            echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Metrics" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat scripts/drift/reports/latest.json | jq '.currentMetrics' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Alerts" >> $GITHUB_STEP_SUMMARY
            cat scripts/drift/reports/latest.json | jq -r '.alerts[] | "- **\(.severity)** [\(.category)]: \(.message)"' >> $GITHUB_STEP_SUMMARY || echo "No alerts" >> $GITHUB_STEP_SUMMARY
          else
            echo "No drift report generated" >> $GITHUB_STEP_SUMMARY
          fi
